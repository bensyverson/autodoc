#!/usr/bin/env node

global.doctrine = require('doctrine');
global.esprima  = require('esprima');
global.Lazy     = require('lazy.js');
global.marked   = require('marked');

var fs          = require('fs'),
    path        = require('path'),
    Breakneck   = require(path.join(__dirname, '../source/javascripts/breakneck')),
    stringTable = require('string-table'),
    commander   = require('commander');

require('colors');
require('should');

var packagePath = path.join(__dirname, '../package.json'),
    packageInfo = JSON.parse(fs.readFileSync(packagePath));

commander
  .version(packageInfo.version)
  .usage(packageInfo.name + ' [options] [file]')
  .option('-t, --test', 'Run tests')
  .parse(process.argv);

function getLast(arr) {
  return arr[arr.length - 1];
}

var file = fs.readFileSync(getLast(process.argv), 'utf-8');

var libraryInfo = Breakneck.parse(file);

function runTests() {
  // Evaluate the file
  eval(file);

  // Run the tests
  Lazy(libraryInfo.docs)
    .filter(function(doc) { return doc.hasExamples; })
    .each(function(doc) {

      console.log(doc.name);

      var outcomes = [];
      Lazy(doc.examples).each(function(example) {
        var outcome = {
          'case': example.input,
          'expected': example.output
        };

        try {
          var actual   = eval(example.input),
              expected = eval(example.output);

          actual.should.eql(expected);

          outcome.result = 'PASS'.green;

        } catch (e) {
          outcome.result = e.message.red;
        }

        outcomes.push(outcome);
      });

      console.log(stringTable.create(outcomes));

    });
}

if (commander.test) {
  runTests();
  return;
}

delete libraryInfo.code;

console.log(JSON.stringify(libraryInfo, null, 2));
